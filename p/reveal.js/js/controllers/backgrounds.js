import{queryAll}from"../utils/util.js";import{colorToRgb,colorBrightness}from"../utils/color.js";export default class Backgrounds{constructor(e){this.Reveal=e}render(){this.element=document.createElement("div"),this.element.className="backgrounds",this.Reveal.getRevealElement().appendChild(this.element)}create(){this.element.innerHTML="",this.element.classList.add("no-transition"),this.Reveal.getHorizontalSlides().forEach((e=>{let t=this.createBackground(e,this.element);queryAll(e,"section").forEach((e=>{this.createBackground(e,t),t.classList.add("stack")}))})),this.Reveal.getConfig().parallaxBackgroundImage?(this.element.style.backgroundImage='url("'+this.Reveal.getConfig().parallaxBackgroundImage+'")',this.element.style.backgroundSize=this.Reveal.getConfig().parallaxBackgroundSize,this.element.style.backgroundRepeat=this.Reveal.getConfig().parallaxBackgroundRepeat,this.element.style.backgroundPosition=this.Reveal.getConfig().parallaxBackgroundPosition,setTimeout((()=>{this.Reveal.getRevealElement().classList.add("has-parallax-background")}),1)):(this.element.style.backgroundImage="",this.Reveal.getRevealElement().classList.remove("has-parallax-background"))}createBackground(e,t){let a=document.createElement("div");a.className="slide-background "+e.className.replace(/present|past|future/,"");let o=document.createElement("div");return o.className="slide-background-content",a.appendChild(o),t.appendChild(a),e.slideBackgroundElement=a,e.slideBackgroundContentElement=o,this.sync(e),a}sync(e){const t=e.slideBackgroundElement,a=e.slideBackgroundContentElement,o={background:e.getAttribute("data-background"),backgroundSize:e.getAttribute("data-background-size"),backgroundImage:e.getAttribute("data-background-image"),backgroundVideo:e.getAttribute("data-background-video"),backgroundIframe:e.getAttribute("data-background-iframe"),backgroundColor:e.getAttribute("data-background-color"),backgroundGradient:e.getAttribute("data-background-gradient"),backgroundRepeat:e.getAttribute("data-background-repeat"),backgroundPosition:e.getAttribute("data-background-position"),backgroundTransition:e.getAttribute("data-background-transition"),backgroundOpacity:e.getAttribute("data-background-opacity")},r=e.hasAttribute("data-preload");e.classList.remove("has-dark-background"),e.classList.remove("has-light-background"),t.removeAttribute("data-loaded"),t.removeAttribute("data-background-hash"),t.removeAttribute("data-background-size"),t.removeAttribute("data-background-transition"),t.style.backgroundColor="",a.style.backgroundSize="",a.style.backgroundRepeat="",a.style.backgroundPosition="",a.style.backgroundImage="",a.style.opacity="",a.innerHTML="",o.background&&(/^(http|file|\/\/)/gi.test(o.background)||/\.(svg|png|jpg|jpeg|gif|bmp|webp)([?#\s]|$)/gi.test(o.background)?e.setAttribute("data-background-image",o.background):t.style.background=o.background),(o.background||o.backgroundColor||o.backgroundGradient||o.backgroundImage||o.backgroundVideo||o.backgroundIframe)&&t.setAttribute("data-background-hash",o.background+o.backgroundSize+o.backgroundImage+o.backgroundVideo+o.backgroundIframe+o.backgroundColor+o.backgroundGradient+o.backgroundRepeat+o.backgroundPosition+o.backgroundTransition+o.backgroundOpacity),o.backgroundSize&&t.setAttribute("data-background-size",o.backgroundSize),o.backgroundColor&&(t.style.backgroundColor=o.backgroundColor),o.backgroundGradient&&(t.style.backgroundImage=o.backgroundGradient),o.backgroundTransition&&t.setAttribute("data-background-transition",o.backgroundTransition),r&&t.setAttribute("data-preload",""),o.backgroundSize&&(a.style.backgroundSize=o.backgroundSize),o.backgroundRepeat&&(a.style.backgroundRepeat=o.backgroundRepeat),o.backgroundPosition&&(a.style.backgroundPosition=o.backgroundPosition),o.backgroundOpacity&&(a.style.opacity=o.backgroundOpacity);let n=o.backgroundColor;if(!n||!colorToRgb(n)){let e=window.getComputedStyle(t);e&&e.backgroundColor&&(n=e.backgroundColor)}if(n){const t=colorToRgb(n);t&&0!==t.a&&(colorBrightness(n)<128?e.classList.add("has-dark-background"):e.classList.add("has-light-background"))}}update(e=!1){let t=this.Reveal.getCurrentSlide(),a=this.Reveal.getIndices(),o=null,r=this.Reveal.getConfig().rtl?"future":"past",n=this.Reveal.getConfig().rtl?"past":"future";if(Array.from(this.element.childNodes).forEach(((t,s)=>{t.classList.remove("past","present","future"),s<a.h?t.classList.add(r):s>a.h?t.classList.add(n):(t.classList.add("present"),o=t),(e||s===a.h)&&queryAll(t,".slide-background").forEach(((e,t)=>{e.classList.remove("past","present","future"),t<a.v?e.classList.add("past"):t>a.v?e.classList.add("future"):(e.classList.add("present"),s===a.h&&(o=e))}))})),this.previousBackground&&this.Reveal.slideContent.stopEmbeddedContent(this.previousBackground,{unloadIframes:!this.Reveal.slideContent.shouldPreload(this.previousBackground)}),o){this.Reveal.slideContent.startEmbeddedContent(o);let e=o.querySelector(".slide-background-content");if(e){let t=e.style.backgroundImage||"";/\.gif/i.test(t)&&(e.style.backgroundImage="",window.getComputedStyle(e).opacity,e.style.backgroundImage=t)}let t=this.previousBackground?this.previousBackground.getAttribute("data-background-hash"):null,a=o.getAttribute("data-background-hash");a&&a===t&&o!==this.previousBackground&&this.element.classList.add("no-transition"),this.previousBackground=o}t&&["has-light-background","has-dark-background"].forEach((e=>{t.classList.contains(e)?this.Reveal.getRevealElement().classList.add(e):this.Reveal.getRevealElement().classList.remove(e)}),this),setTimeout((()=>{this.element.classList.remove("no-transition")}),1)}updateParallax(){let e=this.Reveal.getIndices();if(this.Reveal.getConfig().parallaxBackgroundImage){let t,a,o=this.Reveal.getHorizontalSlides(),r=this.Reveal.getVerticalSlides(),n=this.element.style.backgroundSize.split(" ");1===n.length?t=a=parseInt(n[0],10):(t=parseInt(n[0],10),a=parseInt(n[1],10));let s,i,d=this.element.offsetWidth,l=o.length;s="number"==typeof this.Reveal.getConfig().parallaxBackgroundHorizontal?this.Reveal.getConfig().parallaxBackgroundHorizontal:l>1?(t-d)/(l-1):0,i=s*e.h*-1;let g,c,u=this.element.offsetHeight,b=r.length;g="number"==typeof this.Reveal.getConfig().parallaxBackgroundVertical?this.Reveal.getConfig().parallaxBackgroundVertical:(a-u)/(b-1),c=b>0?g*e.v:0,this.element.style.backgroundPosition=i+"px "+-c+"px"}}destroy(){this.element.remove()}}