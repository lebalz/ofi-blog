import{queryAll,extend,createStyleSheet,matches,closest}from"../utils/util.js";import{FRAGMENT_STYLE_REGEX}from"../utils/constants.js";let autoAnimateCounter=0;export default class AutoAnimate{constructor(t){this.Reveal=t}run(t,e){this.reset();let a=this.Reveal.getSlides(),i=a.indexOf(e),n=a.indexOf(t);if(t.hasAttribute("data-auto-animate")&&e.hasAttribute("data-auto-animate")&&t.getAttribute("data-auto-animate-id")===e.getAttribute("data-auto-animate-id")&&!(i>n?e:t).hasAttribute("data-auto-animate-restart")){this.autoAnimateStyleSheet=this.autoAnimateStyleSheet||createStyleSheet();let a=this.getAutoAnimateOptions(e);t.dataset.autoAnimate="pending",e.dataset.autoAnimate="pending",a.slideDirection=i>n?"forward":"backward";let s="none"===t.style.display;s&&(t.style.display=this.Reveal.getConfig().display);let o=this.getAutoAnimatableElements(t,e).map((t=>this.autoAnimateElements(t.from,t.to,t.options||{},a,autoAnimateCounter++)));if(s&&(t.style.display="none"),"false"!==e.dataset.autoAnimateUnmatched&&!0===this.Reveal.getConfig().autoAnimateUnmatched){let t=.8*a.duration,i=.2*a.duration;this.getUnmatchedAutoAnimateElements(e).forEach((t=>{let e=this.getAutoAnimateOptions(t,a),i="unmatched";e.duration===a.duration&&e.delay===a.delay||(i="unmatched-"+autoAnimateCounter++,o.push(`[data-auto-animate="running"] [data-auto-animate-target="${i}"] { transition: opacity ${e.duration}s ease ${e.delay}s; }`)),t.dataset.autoAnimateTarget=i}),this),o.push(`[data-auto-animate="running"] [data-auto-animate-target="unmatched"] { transition: opacity ${t}s ease ${i}s; }`)}this.autoAnimateStyleSheet.innerHTML=o.join(""),requestAnimationFrame((()=>{this.autoAnimateStyleSheet&&(getComputedStyle(this.autoAnimateStyleSheet).fontWeight,e.dataset.autoAnimate="running")})),this.Reveal.dispatchEvent({type:"autoanimate",data:{fromSlide:t,toSlide:e,sheet:this.autoAnimateStyleSheet}})}}reset(){queryAll(this.Reveal.getRevealElement(),'[data-auto-animate]:not([data-auto-animate=""])').forEach((t=>{t.dataset.autoAnimate=""})),queryAll(this.Reveal.getRevealElement(),"[data-auto-animate-target]").forEach((t=>{delete t.dataset.autoAnimateTarget})),this.autoAnimateStyleSheet&&this.autoAnimateStyleSheet.parentNode&&(this.autoAnimateStyleSheet.parentNode.removeChild(this.autoAnimateStyleSheet),this.autoAnimateStyleSheet=null)}autoAnimateElements(t,e,a,i,n){t.dataset.autoAnimateTarget="",e.dataset.autoAnimateTarget=n;let s=this.getAutoAnimateOptions(e,i);void 0!==a.delay&&(s.delay=a.delay),void 0!==a.duration&&(s.duration=a.duration),void 0!==a.easing&&(s.easing=a.easing);let o=this.getAutoAnimatableProperties("from",t,a),l=this.getAutoAnimatableProperties("to",e,a);if(e.classList.contains("fragment")&&(delete l.styles.opacity,t.classList.contains("fragment"))){(t.className.match(FRAGMENT_STYLE_REGEX)||[""])[0]===(e.className.match(FRAGMENT_STYLE_REGEX)||[""])[0]&&"forward"===i.slideDirection&&e.classList.add("visible","disabled")}if(!1!==a.translate||!1!==a.scale){let t=this.Reveal.getScale(),e={x:(o.x-l.x)/t,y:(o.y-l.y)/t,scaleX:o.width/l.width,scaleY:o.height/l.height};e.x=Math.round(1e3*e.x)/1e3,e.y=Math.round(1e3*e.y)/1e3,e.scaleX=Math.round(1e3*e.scaleX)/1e3,e.scaleX=Math.round(1e3*e.scaleX)/1e3;let i=!1!==a.translate&&(0!==e.x||0!==e.y),n=!1!==a.scale&&(0!==e.scaleX||0!==e.scaleY);if(i||n){let t=[];i&&t.push(`translate(${e.x}px, ${e.y}px)`),n&&t.push(`scale(${e.scaleX}, ${e.scaleY})`),o.styles.transform=t.join(" "),o.styles["transform-origin"]="top left",l.styles.transform="none"}}for(let h in l.styles){const t=l.styles[h],e=o.styles[h];t===e?delete l.styles[h]:(!0===t.explicitValue&&(l.styles[h]=t.value),!0===e.explicitValue&&(o.styles[h]=e.value))}let r="",u=Object.keys(l.styles);if(u.length>0){o.styles.transition="none",l.styles.transition=`all ${s.duration}s ${s.easing} ${s.delay}s`,l.styles["transition-property"]=u.join(", "),l.styles["will-change"]=u.join(", "),r='[data-auto-animate-target="'+n+'"] {'+Object.keys(o.styles).map((t=>t+": "+o.styles[t]+" !important;")).join("")+'}[data-auto-animate="running"] [data-auto-animate-target="'+n+'"] {'+Object.keys(l.styles).map((t=>t+": "+l.styles[t]+" !important;")).join("")+"}"}return r}getAutoAnimateOptions(t,e){let a={easing:this.Reveal.getConfig().autoAnimateEasing,duration:this.Reveal.getConfig().autoAnimateDuration,delay:0};if(a=extend(a,e),t.parentNode){let e=closest(t.parentNode,"[data-auto-animate-target]");e&&(a=this.getAutoAnimateOptions(e,a))}return t.dataset.autoAnimateEasing&&(a.easing=t.dataset.autoAnimateEasing),t.dataset.autoAnimateDuration&&(a.duration=parseFloat(t.dataset.autoAnimateDuration)),t.dataset.autoAnimateDelay&&(a.delay=parseFloat(t.dataset.autoAnimateDelay)),a}getAutoAnimatableProperties(t,e,a){let i=this.Reveal.getConfig(),n={styles:[]};if(!1!==a.translate||!1!==a.scale){let t;if("function"==typeof a.measure)t=a.measure(e);else if(i.center)t=e.getBoundingClientRect();else{let a=this.Reveal.getScale();t={x:e.offsetLeft*a,y:e.offsetTop*a,width:e.offsetWidth*a,height:e.offsetHeight*a}}n.x=t.x,n.y=t.y,n.width=t.width,n.height=t.height}const s=getComputedStyle(e);return(a.styles||i.autoAnimateStyles).forEach((e=>{let a;"string"==typeof e&&(e={property:e}),a=void 0!==e.from&&"from"===t?{value:e.from,explicitValue:!0}:void 0!==e.to&&"to"===t?{value:e.to,explicitValue:!0}:s[e.property],""!==a&&(n.styles[e.property]=a)})),n}getAutoAnimatableElements(t,e){let a=("function"==typeof this.Reveal.getConfig().autoAnimateMatcher?this.Reveal.getConfig().autoAnimateMatcher:this.getAutoAnimatePairs).call(this,t,e),i=[];return a.filter(((t,e)=>{if(-1===i.indexOf(t.to))return i.push(t.to),!0}))}getAutoAnimatePairs(t,e){let a=[];const i="h1, h2, h3, h4, h5, h6, p, li";return this.findAutoAnimateMatches(a,t,e,"[data-id]",(t=>t.nodeName+":::"+t.getAttribute("data-id"))),this.findAutoAnimateMatches(a,t,e,i,(t=>t.nodeName+":::"+t.innerText)),this.findAutoAnimateMatches(a,t,e,"img, video, iframe",(t=>t.nodeName+":::"+(t.getAttribute("src")||t.getAttribute("data-src")))),this.findAutoAnimateMatches(a,t,e,"pre",(t=>t.nodeName+":::"+t.innerText)),a.forEach((t=>{matches(t.from,i)?t.options={scale:!1}:matches(t.from,"pre")&&(t.options={scale:!1,styles:["width","height"]},this.findAutoAnimateMatches(a,t.from,t.to,".hljs .hljs-ln-code",(t=>t.textContent),{scale:!1,styles:[],measure:this.getLocalBoundingBox.bind(this)}),this.findAutoAnimateMatches(a,t.from,t.to,".hljs .hljs-ln-line[data-line-number]",(t=>t.getAttribute("data-line-number")),{scale:!1,styles:["width"],measure:this.getLocalBoundingBox.bind(this)}))}),this),a}getLocalBoundingBox(t){const e=this.Reveal.getScale();return{x:Math.round(t.offsetLeft*e*100)/100,y:Math.round(t.offsetTop*e*100)/100,width:Math.round(t.offsetWidth*e*100)/100,height:Math.round(t.offsetHeight*e*100)/100}}findAutoAnimateMatches(t,e,a,i,n,s){let o={},l={};[].slice.call(e.querySelectorAll(i)).forEach(((t,e)=>{const a=n(t);"string"==typeof a&&a.length&&(o[a]=o[a]||[],o[a].push(t))})),[].slice.call(a.querySelectorAll(i)).forEach(((e,a)=>{const i=n(e);let r;if(l[i]=l[i]||[],l[i].push(e),o[i]){const t=l[i].length-1,e=o[i].length-1;o[i][t]?(r=o[i][t],o[i][t]=null):o[i][e]&&(r=o[i][e],o[i][e]=null)}r&&t.push({from:r,to:e,options:s})}))}getUnmatchedAutoAnimateElements(t){return[].slice.call(t.children).reduce(((t,e)=>{const a=e.querySelector("[data-auto-animate-target]");return e.hasAttribute("data-auto-animate-target")||a||t.push(e),e.querySelector("[data-auto-animate-target]")&&(t=t.concat(this.getUnmatchedAutoAnimateElements(e))),t}),[])}}